---
title: "Turbine Collision Risk: Generate Distribution Data"
description: ""
author:
    - name: "Cédric Scherer"
      url: https://cedricscherer.com
      affiliation: Leibniz Institute for Zoo and Wildlife Research
      affiliation_url: https://www.izw-berlin.de/en/home.html
      orcid_id: 0000-0003-0645-5666
    - name: "Christian Voigt"
      affiliation: Leibniz Institute for Zoo and Wildlife Research
      affiliation_url: https://www.izw-berlin.de/en/home.html
      orcid_id: 0000-0002-0706-3974
date: "`r Sys.Date()`"
output: 
    distill::distill_article:
        highlight: kate
        code_folding: true  
        toc: true            
        toc_depth: 2         
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 18, fig.height = 10, 
                      dev = "ragg_png", res = 1000, retina = 1)
```

## Preparation 

```{r prep}
library(tidyverse)
#library(ggtext)
#library(spatstat.core)
#library(patchwork)

theme_set(theme_light(base_size = 11.5, base_family = "Open Sans"))
theme_update(
  panel.grid.major = element_line(size = .3, color = "grey93"),
  panel.grid.minor = element_blank(),
  panel.grid.major.x = element_blank(),
  strip.background = element_rect(fill = "grey70", colour = "grey70"),
  strip.text = element_text(size = 14, face = "bold"),
  axis.title.x = element_text(size = 14, margin = margin(t = 12)),
  axis.title.y = element_text(size = 14, margin = margin(r = 12)),
  legend.title = element_text(size = 14, face = "bold"),
  legend.text = element_text(size = 12),
  plot.title = element_text(size = 24, face = "bold", margin = margin(5, 0, 5, 0)),
  plot.subtitle = element_text(margin = margin(5, 0, 25, 0), size = 17),
  plot.title.position = "plot",
  plot.margin = margin(rep(25, 4))
)

## source functions to generate and visualize distributions
source(here::here("R", "src", "generate-distributions.R"))
```

## Research Question

* Predictive power of the acoustic monitoring

> Is the predictive power of the current acoustic monitoring sufficient enough to estimate the true number of killed bats?

### Predictions

The predictive power of the acoustic monitoring for the extrapolation of the expected number of stroke victims is decreasing

* in case the crossing bats are not distributed uniformly or randomly.

* with increasing length of the rotor blades.

* for species with high-frequency echo calls.


### Open Questions

* wie die Dichte skalieren zwischen großen und kleinen Windrädern? 
  - z.B. von innen nach außen abhängig von relativer oder absoluter Distanz zum Mittelpunkt?
  
* globale oder lokale Anzahl an Fledermäusen konstant halten?

## Inputs

We have the following parameters we can vary:

* length of rotor blades (`radius_rotor`) - 60 m versus 33 m
  + determines area of wind turbine (`area_rotor` as `pi * radius_rotor^2`)
* proportion of area covered by acoustic monitoring (`proportion_covered`)
  + determines area of acoustic monitoring (`area_monitored` as `area_rotor * proportion_covered`)
  + determines radius to detect bars (`radius_monitored` as `sqrt(area_monitored / pi)`)
* number of bats simulated (`n`)
  + could be either total (for now) or number monitored (maybe later)


## Simulations 

### Generate Several Distributions

```{r run-simulations}
rds <- here::here("output", "data-proc", "simulation-runs-corr-trial.rds")
if (!file.exists(rds)) {
  scenarios <- simulate_multiple_distributions(
    runs = 200,   ## repetitions per combination, also used for seeding
    prop_monitored = seq(.05, .5, by = .05), 
    #n = c(100L, 250L, 500L, 1000L, 5000L, 15000L),
    n = seq(100L, 500L, by = 100L),
    skewness = c(1, 3, 5)
  )
  write_rds(scenarios, rds)
} else {
  scenarios <- read_rds(rds)
}

scenarios_plot <-
  scenarios %>% 
  dplyr::filter(!str_detect(distribution, "_2$|_4$")) %>% 
  #dplyr::filter(distribution != "uniform") %>% 
  dplyr::group_by(n, prop_monitored, distribution) %>% 
  dplyr::mutate(
    diff = prop_monitored - median(prop_n_monitored),
    n = factor(n)
  ) %>% 
  ungroup() %>% 
  mutate(distribution = factor(distribution, levels = c(
    "uniform", "random", "inner", "outer", "bottom_1",
    "bottom_3", "bottom_5", "top_1", "top_3", "top_5"
  )))
```

### Visualization Outcomes

```{r boxplots-jitter-outcomes, fig.width=18, fig.height=10.5}
g <- scenarios_plot %>% 
  ggplot(aes(n, prop_n_monitored)) +
  geom_hline(aes(yintercept = prop_monitored), color = "grey75", size = .7)  + 
  scale_color_gradient2(low = "firebrick", mid = "grey40", high = "firebrick", 
                                 limits = c(-.5, .5), guide = "none") +
  labs(x = "Number of bat passes", y = "Proportion of passes monitored")

## boxplots
g_box <- g + geom_boxplot(aes(color = diff), size = .4, outlier.shape = 1, outlier.size = .3)

## fixed y scale, factor levels
g_box + facet_grid(prop_monitored ~ distribution)
ggsave("./plots/scenarios_boxplots.pdf", width = 18, height = 10.5, device = cairo_pdf)

## free y scale, factor levels
g_box + facet_grid(prop_monitored ~ distribution, scale = "free_y") 
ggsave("./plots/scenarios_boxplots_free.pdf", width = 18, height = 10.5, device = cairo_pdf)


## jitter
g_sina <- g + ggforce::geom_sina(alpha = .3, width = .3, size = .2, shape = 1, stroke = .3) +
  stat_summary(fun = median, color = "firebrick", size = .2, shape = 18)

## fixed y scale, factor levels
g_sina + facet_grid(prop_monitored ~ distribution)
ggsave("./plots/scenarios_jitter.pdf", width = 18, height = 10.5, device = cairo_pdf)

g_sina_line <- g_sina + stat_summary(fun = median, geom = "line", aes(group = 1), color = "firebrick")

## fixed y scale, connected medians
g_sina_line + facet_grid(prop_monitored ~ distribution)
ggsave("./plots/scenarios_jitter_line.pdf", width = 18, height = 10.5, device = cairo_pdf)

## fixed y scale, connected medians
g_sina_line + facet_grid(prop_monitored ~ distribution, scales = "free_y")

ggsave("./plots/scenarios_jitter_free.pdf", width = 18, height = 10.5, device = cairo_pdf)
```

```{r lineplot-outcomes-summary, fig.width=18, fig.height=10.5}
scenarios_plot %>% 
  group_by(distribution, prop_monitored, n) %>% 
  summarize(mean = mean(prop_n_monitored), sd = sd(prop_n_monitored)) %>% 
  #group_by(distribution, prop_monitored, n) %>% 
  ungroup() %>% 
  mutate(
    base = mean - prop_monitored,
    min = base - sd, 
    max = base + sd
  ) %>% 
  ggplot(aes(n, base, color = prop_monitored, group = prop_monitored)) +
  geom_hline(aes(yintercept = 0), color = "grey75", size = 1.2)  + 
  geom_line(size = .9) +
  geom_pointrange(aes(ymin = min, ymax = max), size = .3) +
  facet_wrap(vars(distribution), nrow = 1) +
  scale_x_discrete(expand = c(.03, .03)) +
  scale_y_continuous(breaks = -5:5 / 10) +
  scico::scale_color_scico(
    palette = "bamako", end = .8, direction = -1, name = "Proportion\nmonitored:",
    breaks = seq(.05, .5, by = .05), labels = scales::percent_format()
  ) +
  guides(color = guide_legend(barwidth = unit(.8, "lines"), barheight = unit(12, "lines"))) +
  labs(x = "Number of bat passes", y = "Deviation from expected proportion") +
  theme(panel.spacing.x = unit(.75, "lines"))

ggsave("./plots/scenarios_lines.pdf", width = 20, height = 8.5, device = cairo_pdf)
```


### Visualization Correlation Fatalities

```{r}
scenarios_fct <-
  scenarios %>% 
  mutate(distribution = factor(distribution, levels = c(
    "uniform", "random", "inner", "outer", "bottom_1",
    "bottom_3", "bottom_5", "top_1", "top_3", "top_5"
  )))

theme_update(
  panel.grid.major.y = element_blank(),
  legend.position = "top"
)
```

#### Fatalities vs bat passes

```{r plots-fatalities-passes-reality}
## with variation
# scenarios_fct %>% 
#   ggplot(aes(n, n_fatalities)) +
#   geom_abline(slope = .01, intercept = 0, size = .6, color = "grey75") +
#   geom_jitter(alpha = .02, width = 20, height = 0) +
#   facet_grid(prop_monitored ~ distribution) +
#   geom_quantile(quantiles = c(0.25, 0.75), color = "dodgerblue3", size = .6) +
#   geom_quantile(quantiles = c(0.5), color = "red", size = .9) +
#   labs(x = "Number of bat passes (reality)",
#        y = "Number of fatalities",
#        title = "What really happens",
#        subtitle = "Number of fatalities per number of bat passes (1% correlation + variation)") +
#   theme(panel.grid.major.y = element_blank())
# 
# ggsave("./plots/scenarios_correlation_prop_reality_var.pdf", width = 16, height = 16, device = cairo_pdf)


scenarios_fct %>% 
  filter(prop_monitored == .05) %>% 
  ggplot(aes(n, n_fatalities)) +
  geom_abline(slope = .01, intercept = 0, size = .6, color = "grey75") +
  geom_jitter(alpha = .02, width = 20, height = 0) +
  geom_quantile(quantiles = c(0.25, 0.75), color = "dodgerblue3", size = .6) +
  geom_quantile(quantiles = c(0.5), color = "red", size = .9) +
  facet_grid(~ distribution) +
  labs(x = "Number of bat passes (reality)",
       y = "Number of fatalities",
       title = "What really happens",
       subtitle = "Number of fatalities per number of bat passes (1% correlation + variation)") +
  theme(panel.grid.major.y = element_blank())

ggsave("./plots/scenarios_correlation_prop_reality_var_single.pdf", width = 16, height = 4, device = cairo_pdf)


## fixed
# scenarios_fct %>% 
#   mutate(n_fatalities = round(n / 100)) %>% 
#   ggplot(aes(n, n_fatalities)) +
#   geom_abline(slope = .01, intercept = 0, size = .6, color = "grey75") +
#   geom_point(alpha = .02) +
#   geom_quantile(quantiles = c(0.25, 0.75), color = "dodgerblue3", size = .6) +
#   geom_quantile(quantiles = c(0.5), color = "red", size = .9) +
#   facet_grid(prop_monitored ~ distribution) +
#   labs(x = "Number of bat passes (reality)",
#        y = "Number of fatalities",
#        title = "What really happens",
#        subtitle = "Number of fatalities per number of bat passes (1% correlation without variation)") +
#   theme(panel.grid.major.y = element_blank())
# 
# ggsave("./plots/scenarios_correlation_prop_reality_fix.pdf", width = 16, height = 16, device = cairo_pdf)


scenarios_fct %>% 
  filter(prop_monitored == .05) %>% 
  mutate(n_fatalities = round(n / 100)) %>% 
  ggplot(aes(n, n_fatalities)) +
  geom_abline(slope = .01, intercept = 0, size = .6, color = "grey75") +
  geom_point(alpha = .02) +
  geom_quantile(quantiles = c(0.25, 0.75), color = "dodgerblue3", size = .6) +
  geom_quantile(quantiles = c(0.5), color = "red", size = .9) +
  facet_grid(~ distribution) +
  labs(x = "Number of bat passes (reality)",
       y = "Number of fatalities",
       title = "What really happens",
       subtitle = "Number of fatalities per number of bat passes (1% correlation without variation)") +
  theme(panel.grid.major.y = element_blank())

ggsave("./plots/scenarios_correlation_prop_reality_fix_single.pdf", width = 16, height = 4, device = cairo_pdf)
```

#### Fatalities vs Monitored bat passes

```{r plots-fatalities-passes-monitored}
scenarios_fct %>% 
  ggplot(aes(n_monitored, n_fatalities)) +
  geom_abline(slope = .01, intercept = 0, linetype = "13", size = .6, color = "grey75") +
  geom_point(alpha = .02) +
  geom_quantile(quantiles = c(0.25, 0.75), color = "dodgerblue3", size = .6) +
  geom_quantile(quantiles = c(0.5), color = "red", size = .9) +
  facet_grid(prop_monitored  ~ distribution) +
  labs(x = "Number of bat passes (monitored)",
       y = "Number of fatalities",
       title = "What is detected",
       subtitle = "Number of fatalities per number of monitored bat passes (1% correlation + variation)") +
  theme(panel.grid.major.y = element_blank())

ggsave("./plots/scenarios_correlation_prop_monitored.pdf", width = 16, height = 16, device = cairo_pdf)

scenarios_fct %>% 
  ggplot(aes(n_monitored, n_fatalities)) +
  geom_abline(slope = .01, intercept = 0, linetype = "13", size = .6, color = "grey75") +
  geom_point(alpha = .02) +
  geom_quantile(quantiles = c(0.25, 0.75), color = "dodgerblue3", size = .6) +
  geom_quantile(quantiles = c(0.5), color = "red", size = .9) +
  facet_grid(prop_monitored  ~ distribution, scales = "free_x") +
  labs(x = "Number of bat passes (monitored)",
       y = "Number of fatalities",
       title = "What is detected",
       subtitle = "Number of fatalities per number of monitored bat passes (1% correlation + variation); note the different x axis ranges") +
  theme(panel.grid.major.y = element_blank())

ggsave("./plots/scenarios_correlation_prop_monitored_free.pdf", width = 16, height = 16, device = cairo_pdf)

scenarios_fct %>% 
  mutate(n_fatalities = round(n / 100)) %>% 
  ggplot(aes(n_monitored, n_fatalities)) +
  geom_abline(slope = .01, intercept = 0, linetype = "13", size = .6, color = "grey75") +
  geom_point(alpha = .02) +
  geom_quantile(quantiles = c(0.25, 0.75), color = "dodgerblue3", size = .6) +
  geom_quantile(quantiles = c(0.5), color = "red", size = .9) +
  facet_grid(prop_monitored  ~ distribution) +
  labs(x = "Number of bat passes (monitored)",
       y = "Number of fatalities",
       title = "What is detected",
       subtitle = "Number of fatalities per number of monitored bat passes (1% correlation without variation)") +
  theme(panel.grid.major.y = element_blank())

ggsave("./plots/scenarios_correlation_prop_monitored_fixed.pdf", width = 16, height = 16, device = cairo_pdf)
```



```{r plot-passes-reality-monitored}
scenarios_fct %>% 
  ggplot(aes(n_monitored, n, size = n_fatalities)) +
  geom_abline(slope = 1, intercept = 0, linetype = "13", size = .6, color = "grey75") +
  geom_point(shape = 20, alpha = .0025) +
  #geom_point(shape = 1, color = "black") +
  geom_quantile(quantiles = c(0.25, 0.75), color = "dodgerblue3", size = .6) +
  geom_quantile(quantiles = c(0.5), color = "red", size = .9) +
  facet_grid(prop_monitored  ~ distribution) +
  coord_fixed() +
  scale_x_continuous(limits = c(-50, 600), breaks = c(1, 100, 300, 500)) +
  scale_y_continuous(limits = c(0, 600), breaks = seq(100, 500, by = 100)) +
  scale_size_area(max_size = 12, breaks = seq(0, 10, by = 2), name = "Number of fatalities") +
  guides(size = guide_legend(override.aes = list(alpha = 1), nrow = 1)) +
  labs(x = "Number of bat passes (monitored)",
       y = "Number of bat passes (reality)",
       title = "What is detected",
       subtitle = "Number of simulated bat passes versus monitored bat passes; bubble size encodes the number of fatalities (1% correlation + variation)") +
  theme(panel.grid.major.y = element_blank(), legend.position = "top", 
        axis.text.x = element_text(size = 9))

ggsave("./plots/scenarios_correlation_monitored_vs_reality.pdf", width = 16, height = 16.8, device = cairo_pdf)
```


#### Summaries

```{r}
scenarios_fct %>% 
  group_by(distribution, prop_monitored, n) %>% 
  summarize(
    monitored_avg = mean(n_monitored),
    monitored_sd = sd(n_monitored),
    fatalities_avg = mean(n_fatalities),
    fatalities_sd = sd(n_fatalities)
  ) %>% 
  ggplot(aes(n, monitored_avg, color = distribution)) +
  geom_point(aes(size = fatalities_avg), shape = 20, color = "black", alpha = .2) +
  geom_smooth(method = "lm") +
  facet_grid(prop_monitored~distribution) +
  scale_size_area(max_size = 12, breaks = seq(0, 10, by = 2), name = "Number of fatalities") +
  theme(panel.grid.major.y = element_blank(), legend.position = "top")
```


```{r}
scenarios_fat_pred <-
  scenarios_fct %>% 
  mutate(
    n_fatalities_expected = n / 100,
    n_fatalities_predicted = n_monitored / 100,
    diff_fatalities = n_fatalities_expected - n_fatalities_predicted
  )

scenarios_fat_pred %>% 
  ggplot(aes(n_fatalities_expected, n_fatalities_predicted)) +
  geom_hline(yintercept = 0, size = .6, color = "grey75") +
  geom_abline(slope = 1, intercept = 0, linetype = "13", size = .6, color = "grey75") +
  geom_point(shape = 20, alpha = .0025, size = 2) +
  geom_quantile(quantiles = c(0.25, 0.75), color = "dodgerblue3", size = .6) +
  geom_quantile(quantiles = c(0.5), color = "red", size = .9) +
  facet_grid(prop_monitored  ~ distribution) +
  labs(x = "Number of fatalities (expected, as 1% of all passes)",
       y = "Number of fatalities (predicted, as 1% of passes detected by acoustic monitoring)",
       title = "How good is the predicted fatality risk?",
       subtitle = "Absolute difference between number of fatalities based on acoustic monitoring versus expected (1% correlation + variation)") +
  theme(panel.grid.major.y = element_blank())

ggsave("./plots/scenarios_correlation_fatalities_exp_pred.pdf", width = 16, height = 16, device = cairo_pdf)
  



scenarios_fat_pred %>% 
  mutate(prop_monitored = as.factor(str_sub(prop_monitored, 2, nchar(prop_monitored)))) %>% 
  ggplot(aes(prop_monitored, diff_fatalities)) +
  geom_boxplot(color = "grey60", size = .3, outlier.size = .4, outlier.alpha = .2, outlier.shape = 20) +
  stat_summary(geom = "point", shape = 18, size = 3) +
  facet_wrap(~distribution, nrow = 1) + 
  scale_y_continuous(expand = c(.015, .015)) +
  labs(x = "Proportion covered by acoustic monitoring",
       y = "Absolute difference in fatalities\nexpected – predicted",
       title = "How good is the predicted fatality risk?",
       subtitle = "Absolute difference of actual bat fatalities and predicted fatalies based on monitoring") +
  theme(axis.text.x = element_text(size = 8))

ggsave("./plots/scenarios_correlation_fatalities_difference_box.pdf", width = 18, height = 6, device = cairo_pdf)


scenarios_fat_pred %>% 
  mutate(prop_monitored = as.factor(str_sub(prop_monitored, 2, nchar(prop_monitored)))) %>% 
  ggplot(aes(prop_monitored, diff_fatalities / n_fatalities_expected)) +
  geom_boxplot(color = "grey60", size = .3, outlier.size = .4, outlier.alpha = .2, outlier.shape = 20) +
  stat_summary(geom = "point", shape = 18, size = 3) +
  facet_wrap(~distribution, nrow = 1) + 
  scale_y_continuous(expand = c(.015, .015)) +
  labs(x = "Proportion covered by acoustic monitoring",
       y = "Relative difference in fatalities\n(expected – predicted) / expected",
       title = "How good is the predicted fatality risk?",
       subtitle = "Relative difference of actual bat fatalities and predicted fatalies based on monitoring") +
  theme(axis.text.x = element_text(size = 8))

ggsave("./plots/scenarios_correlation_fatalities_difference_prop_box.pdf", width = 18, height = 6, device = cairo_pdf)


scenarios_fat_pred %>% 
  mutate(prop_monitored = as.factor(str_sub(prop_monitored, 2, nchar(prop_monitored)))) %>% 
  ggplot(aes(prop_monitored, diff_fatalities)) +
  geom_jitter(color = "grey90", height = 0, alpha = .1, width = .3, size = .4) +
  geom_smooth(aes(group = 1), color = "grey40") +
  stat_summary(geom = "point", shape = 18, size = 3) +
  facet_wrap(~distribution, nrow = 1) +
  scale_y_continuous(expand = c(.008, .008)) +
  labs(x = "Proportion covered by acoustic monitoring",
       y = "Absolute difference in fatalities\nexpected – predicted",
       title = "How good is the predicted fatality risk?") +
  theme(axis.text.x = element_text(size = 8))

ggsave("./plots/scenarios_correlation_fatalities_difference_smooth_jitter.pdf", width = 18, height = 6, device = cairo_pdf)

scenarios_fat_pred %>% 
  mutate(prop_monitored = as.factor(str_sub(prop_monitored, 2, nchar(prop_monitored)))) %>% 
  ggplot(aes(prop_monitored, diff_fatalities)) +
  ggbeeswarm::geom_quasirandom(color = "grey90", alpha = .5, width = .3, size = .4) +
  geom_smooth(aes(group = 1), color = "grey40") +
  stat_summary(geom = "point", shape = 18, size = 3) +
  facet_wrap(~distribution, nrow = 1) +
  scale_y_continuous(expand = c(.005, .005)) +
  labs(x = "Proportion covered by acoustic monitoring",
       y = "Absolute difference in fatalities\nexpected – predicted",
       title = "How good is the predicted fatality risk?") +
  theme(axis.text.x = element_text(size = 8))

ggsave("./plots/scenarios_correlation_fatalities_difference_smooth_bee.pdf", width = 18, height = 6, device = cairo_pdf)

scenarios_fat_pred %>% 
  mutate(prop_monitored = as.factor(str_sub(prop_monitored, 2, nchar(prop_monitored)))) %>% 
  ggplot(aes(prop_monitored, diff_fatalities / n_fatalities_expected)) +
  ggbeeswarm::geom_quasirandom(color = "grey90", alpha = .5, width = .3, size = .4) +
  geom_smooth(aes(group = 1), color = "grey40") +
  stat_summary(geom = "point", shape = 18, size = 3) +
  facet_wrap(~distribution, nrow = 1) +
  scale_y_continuous(expand = c(.005, .005)) +
  labs(x = "Proportion covered by acoustic monitoring",
       y = "Relative difference in fatalities\n(expected – predicted) / expected",
       title = "How good is the predicted fatality risk?",
       subtitle = "Relative difference of actual bat fatalities and predicted fatalies based on monitoring") +
  theme(axis.text.x = element_text(size = 8))

ggsave("./plots/scenarios_correlation_fatalities_difference_prop_smooth_bee.pdf", width = 18, height = 6, device = cairo_pdf)


### passes
scenarios_fct %>% 
  mutate(diff_passes = n - (n_monitored / prop_monitored)) %>% 
  mutate(prop_monitored = as.factor(str_sub(prop_monitored, 2, nchar(prop_monitored)))) %>% 
  ggplot(aes(prop_monitored, diff_passes)) +
  geom_boxplot(color = "grey60", size = .3, outlier.size = .4, outlier.alpha = .2, outlier.shape = 20) +
  geom_hline(yintercept = 0, size = .6, linetype = "31", color = "grey75") +
  stat_summary(geom = "point", shape = 18, size = 3) +
  facet_wrap(~distribution, nrow = 1) + 
  scale_y_continuous(expand = c(.012, .012)) +
  labs(x = "Proportion covered by acoustic monitoring",
       y = "Absolute difference in bat passes\nexpected – predicted",
       title = "How much do the actual numbers differ from predicted bat passes?",
       subtitle = "Absolute difference of actual bat passes and monitored bat passes") +
  theme(axis.text.x = element_text(size = 8))

ggsave("./plots/scenarios_correlation_passes_difference_box.pdf", width = 18, height = 6, device = cairo_pdf)


scenarios_fct %>% 
  mutate(diff_passes = (n - (n_monitored / prop_monitored)) / n) %>% 
  mutate(prop_monitored = as.factor(str_sub(prop_monitored, 2, nchar(prop_monitored)))) %>% 
  ggplot(aes(prop_monitored, diff_passes)) +
  geom_boxplot(color = "grey60", size = .3, outlier.size = .4, outlier.alpha = .2, outlier.shape = 20) +
  geom_hline(yintercept = 0, size = .6, linetype = "31", color = "grey75") +
  stat_summary(geom = "point", shape = 18, size = 3) +
  facet_wrap(~distribution, nrow = 1) + 
  scale_y_continuous(expand = c(.018, .018)) +
  labs(x = "Proportion covered by acoustic monitoring",
       y = "Relative difference in bat passes\n(expected – predicted) / expected",
       title = "How much do the actual numbers differ from predicted bat passes?",
       subtitle = "Relative difference of actual bat passes and monitored bat passes") +
  theme(axis.text.x = element_text(size = 8))

ggsave("./plots/scenarios_correlation_passes_difference_prop_box.pdf", width = 18, height = 6, device = cairo_pdf)


scenarios_fct %>% 
  mutate(diff_passes = n - (n_monitored / prop_monitored)) %>% 
  mutate(prop_monitored = as.factor(str_sub(prop_monitored, 2, nchar(prop_monitored)))) %>% 
  ggplot(aes(prop_monitored, diff_passes)) +
  geom_hline(yintercept = 0, size = .6, linetype = "31", color = "grey75") +
  ggbeeswarm::geom_quasirandom(color = "grey90", alpha = .5, width = .3, size = .4) +
  geom_smooth(aes(group = 1), color = "grey50") +
  stat_summary(geom = "point", shape = 18, size = 3) +
  facet_wrap(~distribution, nrow = 1) +
  scale_y_continuous(expand = c(.025, .025)) +
  labs(x = "Proportion covered by acoustic monitoring",
       y = "Absolute difference in bat passes\nexpected – predicted",
       title = "How much do the actual numbers differ from predicted bat passes?",
       subtitle = "Absolute difference of actual bat passes and monitored bat passes") +
  theme(axis.text.x = element_text(size = 8))

ggsave("./plots/scenarios_correlation_passes_difference_smooth_bee.pdf", width = 18, height = 6, device = cairo_pdf)


scenarios_fct %>% 
  mutate(diff_passes = (n - (n_monitored / prop_monitored)) / n) %>% 
  mutate(prop_monitored = as.factor(str_sub(prop_monitored, 2, nchar(prop_monitored)))) %>% 
  ggplot(aes(prop_monitored, diff_passes)) +
  geom_hline(yintercept = 0, size = .6, linetype = "31", color = "grey75") +
  ggbeeswarm::geom_quasirandom(color = "grey90", alpha = .5, width = .3, size = .4) +
  geom_smooth(aes(group = 1), color = "grey50") +
  stat_summary(geom = "point", shape = 18, size = 3) +
  facet_wrap(~distribution, nrow = 1) +
  scale_y_continuous(expand = c(.025, .025)) +
  labs(x = "Proportion covered by acoustic monitoring",
       y = "Relative difference in bat passes\n(expected – predicted) / expected",
       title = "How much do the actual numbers differ from predicted bat passes?",
       subtitle = "Relative difference of actual bat passes and monitored bat passes") +
  theme(axis.text.x = element_text(size = 8))

ggsave("./plots/scenarios_correlation_passes_difference_prop_smooth_bee.pdf", width = 18, height = 6, device = cairo_pdf)













### OLD








scenarios_fct %>% 
  mutate(
    n_fatalities_expected = n / 100,
    n_fatalities_predicted = n_monitored / 100,
    diff_fatalities = n_fatalities_expected - n_fatalities_predicted
  ) %>% 
  ggplot(aes(as.factor(prop_monitored), diff_fatalities)) +
  geom_boxplot(color = "grey67", outlier.size = .4, outlier.alpha = .2, outlier.shape = 20) +
  geom_smooth(aes(group = 1), color = "grey40") +
  stat_summary(geom = "point", shape = 18, size = 2, color = "dodgerblue") +
  facet_wrap(~distribution, nrow = 1)




scenarios_fct %>% 
  mutate(
    n_fatalities_expected = n / 100,
    n_fatalities_predicted = n_monitored / 100,
    diff_fatalities = n_fatalities_expected - n_fatalities_predicted
  ) %>% 
  ggplot(aes(as.factor(prop_monitored), diff_fatalities)) +
  stat_summary(
    fun = function(y) mean(y),
    fun.min = function(y) mean(y) - sd(y),
    fun.max = function(y) mean(y) + sd(y)
  ) +
  facet_wrap(~distribution)
  
scenarios_fct %>% 
  mutate(
    n_fatalities_expected = n / 100,
    n_fatalities_predicted = n_monitored / 100,
    diff_fatalities = n_fatalities_expected - n_fatalities_predicted
  ) %>% 
  ggplot(aes(as.factor(prop_monitored), diff_fatalities)) +
  stat_summary(
    fun = function(y) mean(y),
    fun.min = function(y) mean(y) - sd(y),
    fun.max = function(y) mean(y) + sd(y)
  ) +
  coord_flip() + 
  facet_wrap(~distribution, nrow = 1) +
  labs(x = "Proportion covered by acoustic monitoring",
       y = "Difference of expected versus predicted fatalities")

scenarios_fct %>% 
  mutate(
    n_fatalities_expected = n / 100,
    n_fatalities_predicted = n_monitored / 100,
    diff_fatalities = n_fatalities_expected - n_fatalities_predicted
  ) %>% 
  ggplot(aes(as.factor(prop_monitored), diff_fatalities)) +
  #geom_violin(bw = .5, fill = "grey85") +
  geom_point(alpha = .025, shape = "|", color = "grey40", size = 3, position = position_nudge(-.1)) +
  stat_summary(
    fun = function(y) mean(y),
    fun.min = function(y) mean(y) - sd(y),
    fun.max = function(y) mean(y) + sd(y),
    shape = 18, size = 1.5, position = position_nudge(.1)
  ) +
  #stat_summary(geom = "point", color = "red", shape = 18, size = 6) +
  coord_flip() + 
  facet_wrap(~distribution, nrow = 1)



scenarios_fct %>% 
  mutate(
    n_fatalities_expected = n / 100,
    n_fatalities_predicted = n_monitored / 100,
    diff_fatalities = n_fatalities_expected - n_fatalities_predicted
  ) %>% 
  ggplot(aes(distribution, diff_fatalities)) +
  #geom_violin(bw = .5, fill = "grey85") +
  geom_point(alpha = .025, shape = "-", color = "grey40", size = 3, position = position_nudge(-.1)) +
  stat_summary(
    fun = function(y) mean(y),
    fun.min = function(y) mean(y) - sd(y),
    fun.max = function(y) mean(y) + sd(y),
    shape = 18, size = 1.5, position = position_nudge(.1)
  ) +
  #stat_summary(geom = "point", color = "red", shape = 18, size = 6) +
  #coord_flip() + 
  facet_wrap(~prop_monitored, ncol = 1)



# group_by(distribution, prop_monitored, n) %>% 
#   summarize(
#     monitored_avg = mean(n_monitored),
#     monitored_sd = sd(n_monitored),
#     fatalities_avg = mean(n_fatalities),
#     fatalities_sd = sd(n_fatalities)
#   ) 
# 
#   
#   ggplot(aes(n, monitored_avg, color = distribution)) +
#   geom_point(aes(size = fatalities_avg), shape = 20, color ="black", alpha = .2) +
#   geom_smooth(method = "lm") +
#   facet_grid(prop_monitored~distribution) +
#   scale_size_area(max_size = 12, breaks = seq(0, 10, by = 2), name = "Number of fatalities")
```



```{r convert-pdf, incldue = FALSE}
## convert PDFs to PNGs
pdfs <- list.files(here::here("plots"), pattern = "scenarios_.*pdf")
for(pdf in pdfs) {
  pdftools::pdf_convert(
    pdf = glue::glue("{here::here('plots')}/{pdf}"), 
    filenames = glue::glue("{here::here('plots')}/{str_remove(pdf, '.pdf')}.png"),
    format = "png", dpi = 300
  )
}
```


***

<details><summary>Session Info</summary>

```{r sessionInfo}
Sys.time()
sessionInfo()
```

</details>
